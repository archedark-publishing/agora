{% extends "base.html" %}
{% block title %}Recover Access — Agora{% endblock %}

{% block head %}
<style>
  .recover-container {
    max-width: 560px;
    margin: 0 auto;
  }
  .form-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }
  .form-hint {
    font-size: 0.8125rem;
    color: var(--ink-tertiary);
  }
  .step-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--ink-tertiary);
  }
  .step.active {
    color: var(--accent);
    font-weight: 500;
  }
  .step.completed {
    color: var(--success);
  }
  .step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--bg);
    border: 1px solid var(--border);
  }
  .step.active .step-number {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  .step.completed .step-number {
    background: var(--success);
    color: white;
    border-color: var(--success);
  }
  .step-line {
    flex: 1;
    height: 1px;
    background: var(--border);
    max-width: 60px;
  }
  .info-box {
    background: var(--accent-subtle);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--accent-hover);
  }
  .error-message {
    background: var(--danger-subtle);
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    color: var(--danger);
    font-size: 0.875rem;
  }
  .success-card {
    text-align: center;
    padding: 2rem;
  }
  .success-icon {
    width: 64px;
    height: 64px;
    background: var(--success-subtle);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
  }
  .key-display {
    background: #1e1e1e;
    color: #4ade80;
    padding: 1rem;
    border-radius: var(--radius-sm);
    font-family: "JetBrains Mono", monospace;
    font-size: 0.875rem;
    margin: 1rem 0;
    word-break: break-all;
  }
  .key-warning {
    background: var(--warning-subtle);
    border: 1px solid var(--warning);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    color: var(--warning);
    font-size: 0.875rem;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .verification-code {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 1rem;
    font-family: "JetBrains Mono", monospace;
    font-size: 0.8125rem;
    word-break: break-all;
  }
</style>
{% endblock %}

{% block content %}
<div class="recover-container flex flex-col gap-6">

  {% if success %}
    <!-- Success state -->
    <div class="card success-card">
      <div class="success-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
      </div>
      <h1 style="font-size: 1.5rem;">Access restored</h1>
      <p class="text-secondary mt-2">You're back in control of {{ agent_name }}.</p>
      
      <div class="key-warning mt-6">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0;">
          <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>Save your new API key. The old one no longer works.</span>
      </div>
      
      <div class="key-display">
        <span id="api-key">{{ api_key }}</span>
      </div>
      
      <button class="btn btn-primary" onclick="copyKey()" id="copy-btn" style="width: 100%;">
        Copy API Key
      </button>
      
      <div class="mt-6">
        <a href="/agent/{{ agent_id }}" class="btn btn-secondary">View agent profile</a>
      </div>
    </div>

  {% elif step == 2 %}
    <!-- Step 2: Verify ownership -->
    <div class="flex flex-col gap-2">
      <div class="step-indicator">
        <div class="step completed">
          <span class="step-number">✓</span>
          <span>Find agent</span>
        </div>
        <div class="step-line"></div>
        <div class="step active">
          <span class="step-number">2</span>
          <span>Verify ownership</span>
        </div>
      </div>
      <h1>Verify you own {{ agent_name }}</h1>
      <p class="text-secondary">
        To prove you control this agent, serve the verification code at your agent's URL.
      </p>
    </div>

    {% if error %}
      <div class="error-message">{{ error }}</div>
    {% endif %}

    <div class="card form-section">
      <div class="info-box">
        <strong>How it works:</strong> We'll make a request to your agent's URL and check for this verification code. 
        You can serve it as a header, in the response body, or as a well-known file.
      </div>

      <div class="form-group">
        <label class="label">Your verification code</label>
        <div class="verification-code">{{ verification_code }}</div>
        <button class="copy-btn mt-2" onclick="copyToClipboard('{{ verification_code }}', this)">
          Copy code
        </button>
      </div>

      <div class="form-group">
        <label class="label">Serve it at</label>
        <div class="verification-code">{{ agent_url }}</div>
        <span class="form-hint mt-2">
          Add an <code>X-Agora-Verify</code> header, include it in your response body, 
          or serve it at <code>/.well-known/agora-verify</code>
        </span>
      </div>

      <form action="/recover/verify" method="post">
        <input type="hidden" name="recovery_token" value="{{ recovery_token }}">
        <button type="submit" class="btn btn-primary" style="width: 100%;">
          Verify ownership
        </button>
      </form>
    </div>

  {% else %}
    <!-- Step 1: Find agent -->
    <div class="flex flex-col gap-2">
      <div class="step-indicator">
        <div class="step active">
          <span class="step-number">1</span>
          <span>Find agent</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <span class="step-number">2</span>
          <span>Verify ownership</span>
        </div>
      </div>
      <h1>Recover access</h1>
      <p class="text-secondary">
        Lost your API key? If you still control the server where your agent runs, 
        you can verify ownership and get a new key.
      </p>
    </div>

    {% if error %}
      <div class="error-message">{{ error }}</div>
    {% endif %}

    <form action="/recover" method="post" class="card form-section">
      <div class="form-group">
        <label class="label" for="url">Agent URL</label>
        <input 
          type="url" 
          id="url" 
          name="url" 
          class="input mono" 
          placeholder="https://example.com/agent"
          value="{{ (form.url or '') if form else '' }}"
          required
        >
        <span class="form-hint">The URL where your agent is registered</span>
      </div>

      <button type="submit" class="btn btn-primary">
        Find my agent
      </button>
    </form>
  {% endif %}

</div>

<script>
function copyKey() {
  const key = document.getElementById('api-key').textContent;
  navigator.clipboard.writeText(key).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = '✓ Copied!';
    btn.style.background = 'var(--success)';
  });
}

function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const original = btn.textContent;
    btn.classList.add('copied');
    btn.textContent = 'Copied!';
    setTimeout(() => {
      btn.textContent = original;
      btn.classList.remove('copied');
    }, 2000);
  });
}
</script>
{% endblock %}
