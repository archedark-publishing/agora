{% extends "base.html" %}
{% block title %}Recover Access — Agora{% endblock %}

{% block head %}
<style>
  .recover-container {
    max-width: 560px;
    margin: 0 auto;
  }
  .form-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }
  .form-hint {
    font-size: 0.8125rem;
    color: var(--ink-tertiary);
  }
  .step-indicator {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--ink-tertiary);
  }
  .step.active {
    color: var(--accent);
    font-weight: 500;
  }
  .step.completed {
    color: var(--success);
  }
  .step-number {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--bg);
    border: 1px solid var(--border);
  }
  .step.active .step-number {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  .step.completed .step-number {
    background: var(--success);
    color: white;
    border-color: var(--success);
  }
  .step-line {
    flex: 1;
    height: 1px;
    background: var(--border);
    max-width: 60px;
  }
  .info-box {
    background: var(--accent-subtle);
    border: 1px solid var(--accent);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--accent-hover);
  }
  .error-message {
    background: var(--danger-subtle);
    border: 1px solid var(--danger);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    color: var(--danger);
    font-size: 0.875rem;
  }
  .success-card {
    text-align: center;
    padding: 2rem;
  }
  .success-icon {
    width: 64px;
    height: 64px;
    background: var(--success-subtle);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
  }
  .key-display {
    background: #1e1e1e;
    color: #4ade80;
    padding: 1rem;
    border-radius: var(--radius-sm);
    font-family: "JetBrains Mono", monospace;
    font-size: 0.875rem;
    margin: 1rem 0;
    word-break: break-all;
  }
  .key-warning {
    background: var(--warning-subtle);
    border: 1px solid var(--warning);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    color: var(--warning);
    font-size: 0.875rem;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .verification-code {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 1rem;
    font-family: "JetBrains Mono", monospace;
    font-size: 0.8125rem;
    word-break: break-all;
  }
</style>
{% endblock %}

{% block content %}
<div class="recover-container flex flex-col gap-6">

  {% if complete_result %}
    <!-- Success state -->
    <div class="card success-card">
      <div class="success-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
          <path d="M20 6L9 17l-5-5"/>
        </svg>
      </div>
      <h1 style="font-size: 1.5rem;">Access restored</h1>
      <p class="text-secondary mt-2">{{ complete_result.message }}</p>
      
      <div class="mt-6">
        <a href="/agent/{{ complete_result.agent_id }}" class="btn btn-secondary">View agent profile</a>
      </div>
    </div>

  {% elif start_result %}
    <!-- Step 2: Complete recovery -->
    <div class="flex flex-col gap-2">
      <div class="step-indicator">
        <div class="step completed">
          <span class="step-number">✓</span>
          <span>Find agent</span>
        </div>
        <div class="step-line"></div>
        <div class="step active">
          <span class="step-number">2</span>
          <span>Rotate key</span>
        </div>
      </div>
      <h1>Complete recovery</h1>
      <p class="text-secondary">
        Publish the verification challenge, then submit a new API key to rotate ownership.
      </p>
    </div>

    {% if complete_error %}
      <div class="error-message">{{ complete_error }}</div>
    {% endif %}

    <div class="card form-section">
      <div class="info-box">
        <strong>Verification challenge:</strong> serve this token at
        <code>{{ start_result.verify_url }}</code>
        as <code>X-Agora-Verify</code>, in the body, or at <code>/.well-known/agora-verify</code>.
      </div>

      <div class="form-group">
        <label class="label">Your verification code</label>
        <div class="verification-code" id="challenge-token">{{ start_result.challenge_token }}</div>
        <button class="copy-btn mt-2" onclick="copyToClipboard('{{ start_result.challenge_token }}', this)">
          Copy code
        </button>
      </div>

      <div class="form-group">
        <label class="label" for="new_api_key">New API key</label>
        <input
          type="password"
          id="new_api_key"
          name="new_api_key"
          class="input mono"
          placeholder="new-owner-api-key"
          required
          form="recover-complete-form"
        >
        <span class="form-hint">This replaces the previous owner key immediately.</span>
      </div>

      <form id="recover-complete-form" action="/recover/complete" method="post">
        <input type="hidden" name="agent_id" value="{{ start_result.agent_id }}">
        <input type="hidden" name="recovery_session_secret" value="{{ recovery_session_secret_value }}">
        <button type="submit" class="btn btn-primary" style="width: 100%;">
          Complete recovery
        </button>
      </form>
    </div>

  {% else %}
    <!-- Step 1: Find agent -->
    <div class="flex flex-col gap-2">
      <div class="step-indicator">
        <div class="step active">
          <span class="step-number">1</span>
          <span>Find agent</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
          <span class="step-number">2</span>
          <span>Rotate key</span>
        </div>
      </div>
      <h1>Recover access</h1>
      <p class="text-secondary">
        Lost your API key? Start recovery using your agent UUID.
      </p>
    </div>

    {% if start_error %}
      <div class="error-message">{{ start_error }}</div>
    {% endif %}

    <form action="/recover/start" method="post" class="card form-section">
      <div class="form-group">
        <label class="label" for="agent_id">Agent ID (UUID)</label>
        <input 
          type="text"
          id="agent_id"
          name="agent_id"
          class="input mono" 
          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          value="{{ agent_id_value or '' }}"
          required
        >
        <span class="form-hint">You can find this in your agent detail URL.</span>
      </div>

      <button type="submit" class="btn btn-primary">
        Start recovery
      </button>
    </form>
  {% endif %}

</div>

<script>
function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const original = btn.textContent;
    btn.classList.add('copied');
    btn.textContent = 'Copied!';
    setTimeout(() => {
      btn.textContent = original;
      btn.classList.remove('copied');
    }, 2000);
  });
}
</script>
{% endblock %}
