{% extends "base.html" %}
{% from "_badges.html" import health_badge, stale_badge %}
{% block title %}Search Agents{% endblock %}
{% block content %}
<section class="panel stack">
  <h1 style="margin: 0;">Search Registry</h1>
  <p class="muted" style="margin: 0;">Default ordering: healthy, unknown, unhealthy, then newest first.</p>
  <form method="get" action="/search" class="grid">
    <label>
      Query
      <input type="text" name="q" value="{{ filters.q }}" placeholder="Search name, description, skills, tags">
    </label>
    <label>
      Skill IDs (comma separated)
      <input type="text" name="skill" value="{{ filters.skill }}" placeholder="weather,translation">
    </label>
    <label>
      Capabilities (comma separated)
      <input type="text" name="capability" value="{{ filters.capability }}" placeholder="streaming,batch">
    </label>
    <label>
      Tags (comma separated)
      <input type="text" name="tag" value="{{ filters.tag }}" placeholder="research,finance">
    </label>
    <label>
      Health
      <select name="health">
        <option value="" {% if filters.health == "" %}selected{% endif %}>All</option>
        <option value="healthy" {% if filters.health == "healthy" %}selected{% endif %}>Healthy</option>
        <option value="unknown" {% if filters.health == "unknown" %}selected{% endif %}>Unknown</option>
        <option value="unhealthy" {% if filters.health == "unhealthy" %}selected{% endif %}>Unhealthy</option>
      </select>
    </label>
    <label>
      Stale
      <select name="stale">
        <option value="" {% if filters.stale == "" %}selected{% endif %}>All</option>
        <option value="true" {% if filters.stale == "true" %}selected{% endif %}>Stale only</option>
        <option value="false" {% if filters.stale == "false" %}selected{% endif %}>Not stale</option>
      </select>
    </label>
    <label>
      Limit
      <input type="number" min="1" max="200" name="limit" value="{{ filters.limit }}">
    </label>
    <input type="hidden" name="offset" value="0">
    <button type="submit">Apply Filters</button>
  </form>
</section>

<section class="panel stack" style="margin-top: 1rem;">
  <h2 style="margin: 0;">Results ({{ results.total }})</h2>
  {% if results.agents %}
    <div class="stack">
      {% for agent in results.agents %}
        <article class="panel stack">
          <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
            <a href="/agent/{{ agent.id }}" style="font-weight: 700; color: var(--ink); text-decoration: none;">{{ agent.name }}</a>
            <div style="display: inline-flex; gap: 0.35rem;">
              {{ health_badge(agent.health_status) }}
              {{ stale_badge(agent.is_stale, agent.stale_days) }}
            </div>
          </div>
          <p class="muted" style="margin: 0;">{{ agent.description or "" }}</p>
          <p class="mono" style="margin: 0;">{{ agent.url }}</p>
          <p class="muted" style="margin: 0;">Skills: {{ agent.skills | join(", ") }}</p>
        </article>
      {% endfor %}
    </div>
    <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
      {% if has_previous %}
        <a class="panel" style="text-decoration: none; color: var(--ink);" href="/search?q={{ filters.q }}&skill={{ filters.skill }}&capability={{ filters.capability }}&tag={{ filters.tag }}&health={{ filters.health }}&stale={{ filters.stale }}&limit={{ filters.limit }}&offset={{ previous_offset }}">Previous</a>
      {% endif %}
      {% if has_next %}
        <a class="panel" style="text-decoration: none; color: var(--ink);" href="/search?q={{ filters.q }}&skill={{ filters.skill }}&capability={{ filters.capability }}&tag={{ filters.tag }}&health={{ filters.health }}&stale={{ filters.stale }}&limit={{ filters.limit }}&offset={{ next_offset }}">Next</a>
      {% endif %}
    </div>
  {% else %}
    <p class="muted">No matching agents.</p>
  {% endif %}
</section>
{% endblock %}
