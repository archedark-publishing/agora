{% extends "base.html" %}
{% from "_badges.html" import health_badge, verified_badge, tenure_badge, a2a_badge %}
{% block title %}{{ agent.name }} — Agent Agora{% endblock %}

{% block head %}
<style>
  .agent-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .agent-title {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .agent-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .detail-grid {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 0.75rem 1.5rem;
    font-size: 0.9375rem;
  }
  .detail-label {
    color: var(--ink-tertiary);
    font-weight: 500;
  }
  .detail-value {
    color: var(--ink);
  }
  .health-timeline {
    display: flex;
    gap: 2px;
    height: 24px;
    align-items: stretch;
  }
  .health-bar {
    flex: 1;
    border-radius: 2px;
    min-width: 3px;
  }
  .health-bar.healthy { background: var(--success); }
  .health-bar.stale { background: var(--warning); }
  .health-bar.unhealthy { background: var(--danger); }
  .health-bar.unknown { background: var(--border); }
  .skills-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .skill-tag {
    display: inline-flex;
    padding: 0.375rem 0.75rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.8125rem;
    color: var(--ink-secondary);
  }
  .code-block {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1rem;
    border-radius: var(--radius-sm);
    font-family: "JetBrains Mono", monospace;
    font-size: 0.8125rem;
    overflow-x: auto;
    white-space: pre;
  }
  .action-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  @media (max-width: 640px) {
    .detail-grid {
      grid-template-columns: 1fr;
      gap: 0.25rem 0;
    }
    .detail-label { margin-top: 0.75rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-8">

  <!-- Back link -->
  <a href="/search" class="text-sm text-tertiary" style="text-decoration: none;">
    ← Back to search
  </a>

  <!-- Header -->
  <section class="card">
    <div class="agent-header">
      <div class="agent-title">
        <div class="flex flex-col gap-2">
          <h1>{{ agent.name }}</h1>
          {% if agent.description %}
            <p class="text-secondary" style="max-width: 600px;">{{ agent.description }}</p>
          {% endif %}
        </div>
        <div class="agent-badges">
          {{ health_badge(agent.health_status) }}
          {{ verified_badge(agent.is_verified) }}
          {{ tenure_badge(agent.tenure_days) }}
          {{ a2a_badge(agent.agent_card_url) }}
        </div>
      </div>
      
      <div class="flex items-center gap-4 mt-2">
        <a href="{{ agent.url }}" target="_blank" rel="noopener" class="mono text-sm" style="color: var(--accent);">
          {{ agent.url }}
        </a>
        <button class="copy-btn" onclick="copyToClipboard('{{ agent.url }}', this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
          </svg>
          Copy URL
        </button>
      </div>
    </div>
  </section>

  <!-- Health history -->
  {% if health_history %}
  <section class="flex flex-col gap-3">
    <h2>Health History <span class="text-sm text-tertiary" style="font-weight: 400;">(last 30 days)</span></h2>
    <div class="card">
      <div class="health-timeline" title="Health checks over the last 30 days">
        {% for day in health_history %}
          <div class="health-bar {{ day.status }}" title="{{ day.date }}: {{ day.status }}"></div>
        {% endfor %}
      </div>
      <div class="flex justify-between mt-3 text-xs text-tertiary">
        <span>30 days ago</span>
        <span>Today</span>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Details -->
  <section class="flex flex-col gap-3">
    <h2>Details</h2>
    <div class="card">
      <div class="detail-grid">
        <span class="detail-label">Protocol</span>
        <span class="detail-value mono">{{ agent.protocol_version|default('A2A v0.3') }}</span>
        
        <span class="detail-label">Registered</span>
        <span class="detail-value">{{ agent.created_at.strftime('%b %d, %Y') if agent.created_at else 'Unknown' }}</span>
        
        <span class="detail-label">Last healthy</span>
        <span class="detail-value">
          {% if agent.last_healthy_at %}
            {{ agent.last_healthy_at.strftime('%b %d, %Y at %H:%M') if agent.last_healthy_at else 'Unknown' }}
          {% else %}
            Never checked
          {% endif %}
        </span>
        
        {% if agent.version %}
        <span class="detail-label">Version</span>
        <span class="detail-value">{{ agent.version }}</span>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Reputation -->
  <section class="flex flex-col gap-3">
    <h2>Reputation</h2>
    <div class="card">
      <div class="detail-grid">
        <span class="detail-label">Reliability reports (30d)</span>
        <span class="detail-value">{{ reputation.reliability.total_reports }}</span>

        <span class="detail-label">Response rate</span>
        <span class="detail-value">
          {% if reputation.reliability.response_rate is not none %}
            {{ (reputation.reliability.response_rate * 100)|round(1) }}%
          {% else %}
            n/a
          {% endif %}
        </span>

        <span class="detail-label">Latency p50 / p95</span>
        <span class="detail-value">
          {% if reputation.reliability.latency_p50 is not none %}
            {{ reputation.reliability.latency_p50|round(0) }}ms / {{ reputation.reliability.latency_p95|round(0) if reputation.reliability.latency_p95 is not none else 'n/a' }}
          {% else %}
            n/a
          {% endif %}
        </span>

        <span class="detail-label">Validity rate</span>
        <span class="detail-value">
          {% if reputation.reliability.validity_rate is not none %}
            {{ (reputation.reliability.validity_rate * 100)|round(1) }}%
          {% else %}
            n/a
          {% endif %}
        </span>

        <span class="detail-label">Terms honored rate</span>
        <span class="detail-value">
          {% if reputation.reliability.terms_honor_rate is not none %}
            {{ (reputation.reliability.terms_honor_rate * 100)|round(1) }}%
          {% else %}
            n/a
          {% endif %}
        </span>

        <span class="detail-label">Incident count</span>
        <span class="detail-value">{{ reputation.incidents.total }}</span>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 0.75rem;">Recent public incidents</h3>
      {% if reputation.incidents.recent %}
        <div class="flex flex-col gap-3">
          {% for incident in reputation.incidents.recent %}
            <div style="border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0.75rem;">
              <div class="flex items-center justify-between gap-2">
                <strong style="font-size: 0.875rem;">{{ incident.category }}</strong>
                <span class="text-xs text-tertiary">{{ incident.reported_at[:10] }}</span>
              </div>
              <p class="text-sm text-secondary mt-1">{{ incident.description }}</p>
              {% if incident.subject_response %}
                <p class="text-xs mt-2"><strong>Subject response:</strong> {{ incident.subject_response }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-secondary text-sm">No public incidents reported yet.</p>
      {% endif %}
    </div>

    <div class="card">
      <h3 style="margin-bottom: 0.75rem;">Submit incident report (authenticated)</h3>
      <p class="text-xs text-tertiary" style="margin-bottom: 0.75rem;">
        Submission requires a valid reporter API key.
      </p>
      <form id="incident-form" class="flex flex-col gap-3">
        <input type="password" id="incident-api-key" class="input" placeholder="Reporter API key" required>
        <div class="grid grid-cols-3 gap-3">
          <select id="incident-category" class="input" required>
            {% for category in incident_categories %}
              <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
          </select>
          <select id="incident-outcome" class="input">
            <option value="">(no outcome yet)</option>
            {% for outcome in incident_outcomes %}
              <option value="{{ outcome }}">{{ outcome }}</option>
            {% endfor %}
          </select>
          <select id="incident-visibility" class="input" required>
            {% for visibility in incident_visibilities %}
              <option value="{{ visibility }}">{{ visibility }}</option>
            {% endfor %}
          </select>
        </div>
        <textarea id="incident-description" class="input" rows="5" minlength="50" maxlength="2000" placeholder="Describe the incident (50-2000 chars)" required></textarea>
        <div class="flex items-center gap-2">
          <button type="submit" class="btn btn-secondary">Submit incident</button>
          <span id="incident-form-status" class="text-xs text-tertiary"></span>
        </div>
      </form>
    </div>
  </section>

  <!-- Skills / Capabilities -->
  {% if agent.skills %}
  <section class="flex flex-col gap-3">
    <h2>Capabilities</h2>
    <div class="card">
      <div class="skills-list">
        {% for skill in agent.skills %}
          <span class="skill-tag">{{ skill.name|default(skill.id) }}</span>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Agent Card JSON -->
  <section class="flex flex-col gap-3">
    <div class="flex items-center justify-between">
      <h2>Agent Card</h2>
      <button class="copy-btn" onclick="copyToClipboard(document.getElementById('agent-card-json').textContent, this)">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
          <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
        </svg>
        Copy JSON
      </button>
    </div>
    <div class="code-block" id="agent-card-json">{{ agent.card | tojson(indent=2) }}</div>
  </section>

  <!-- Owner actions (if authenticated) -->
  {% if is_owner %}
  <section class="flex flex-col gap-3">
    <h2>Manage Agent</h2>
    <div class="action-buttons">
      <a href="/agent/{{ agent.id }}/edit" class="btn btn-secondary">Edit agent</a>
      <button class="btn btn-secondary" style="color: var(--danger);" onclick="confirmDelete()">Delete agent</button>
    </div>
  </section>
  {% endif %}

</div>

<script>
function copyToClipboard(text, btn) {
  navigator.clipboard.writeText(text).then(() => {
    const original = btn.innerHTML;
    btn.classList.add('copied');
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Copied!';
    setTimeout(() => {
      btn.innerHTML = original;
      btn.classList.remove('copied');
    }, 2000);
  });
}

const incidentForm = document.getElementById('incident-form');
if (incidentForm) {
  incidentForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const statusEl = document.getElementById('incident-form-status');
    const apiKey = document.getElementById('incident-api-key').value;
    const category = document.getElementById('incident-category').value;
    const outcome = document.getElementById('incident-outcome').value;
    const visibility = document.getElementById('incident-visibility').value;
    const description = document.getElementById('incident-description').value;

    statusEl.textContent = 'Submitting…';
    try {
      const response = await fetch('/api/v1/agents/{{ agent.id }}/incidents', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-API-Key': apiKey,
        },
        body: JSON.stringify({
          category,
          description,
          outcome: outcome || null,
          visibility,
        }),
      });
      if (!response.ok) {
        const payload = await response.json().catch(() => ({}));
        statusEl.textContent = payload.detail || 'Submission failed';
        return;
      }
      statusEl.textContent = 'Incident submitted. Refresh to see updates.';
      incidentForm.reset();
    } catch (error) {
      statusEl.textContent = 'Submission failed';
    }
  });
}

function confirmDelete() {
  if (confirm('Are you sure you want to delete this agent? This cannot be undone.')) {
    fetch('/api/v1/agents/{{ agent.id }}', { method: 'DELETE' })
      .then(r => { if (r.ok) window.location = '/search'; });
  }
}
</script>
{% endblock %}
